<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MQTT Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      font-size: 35px;
      background-image: url('background.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    .container {
      text-align: center;
      margin-top: 80px;
    }

    h1 {
      margin-bottom: 30px;
      color: rgb(232, 244, 5);
      font-size: 100px;
      -webkit-text-stroke: 2px black;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-size: 50px;
      font-weight: bolder;
      color: deeppink;
      -webkit-text-stroke: 1.5px black;
    }

    input[type="text"] {
      text-align: center;
      padding: 10px;
      font-size: 40px;
      width: 300px;
      border-radius: 10px;
    }

    #status {
      display: block;
      margin-top: 30px;
      font-size: 40px;
      font-weight: bold;
      color: orange;
      -webkit-text-stroke: 1px black;
    }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GIÁM SÁT NHIỆT ĐỘ<br>TỦ BẢO QUẢN LINE 3</h1>

    <label for="name">Nhiệt độ:</label>
    <input id="temp" type="text" value="Đang kết nối..." readonly>

    <span id="status">⏳ Đang kết nối...</span>
  </div>

  <script>
    const options = {
      username: "user01",
      password: "Zxcv1234",
      connectTimeout: 5000,
      clean: true,
      reconnectPeriod: 1000
    };

    const client = mqtt.connect("wss://6142ecdbd79141889c4aff6297385b1d.s1.eu.hivemq.cloud:8884/mqtt", options);

    let lastMessageTime = Date.now();

    client.on('connect', () => {
      console.log('✅ Đã kết nối MQTT WebSocket');
      client.subscribe("esp32/temperatureC", function (err) {
        if (!err) {
          console.log("✅ Đã subscribe topic");
        }
      });
    });

    client.on('message', function (topic, message) {
      if (topic === "esp32/temperatureC") {
        const temp = message.toString();
        if (temp === "-127.0" || temp === "-127") {
          document.getElementById("temp").value = "Lỗi cảm biến";
          document.getElementById("status").innerText = "⚠️ Cảm biến không phản hồi!";
          document.getElementById("status").style.color = "orange";
        } else {
          document.getElementById("temp").value = temp + " °C";
          document.getElementById("status").innerText = "✅ Đã kết nối";
          document.getElementById("status").style.color = "lightgreen";
        }

        // cập nhật thời gian nhận gói cuối
        lastMessageTime = Date.now();
        document.getElementById("status").innerText = "✅ Đã kết nối";
        document.getElementById("status").style.color = "lightgreen";
      }
    });

    client.on('error', function (err) {
      console.error("❌ Lỗi MQTT: ", err);
    });

    // Kiểm tra mất kết nối nếu không nhận dữ liệu trong 10 giây
    setInterval(() => {
      const delta = Date.now() - lastMessageTime;
      if (delta > 10000) {
        document.getElementById("status").innerText = "❌ Mất kết nối ESP32";
        document.getElementById("status").style.color = "red";
      }
    }, 2000);
  </script>
</body>
</html>
